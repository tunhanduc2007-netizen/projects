rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // üîß HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user has specific role
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    // Check if user is admin
    function isAdmin() {
      return hasRole('admin');
    }
    
    // Check if user is staff or admin
    function isStaff() {
      return hasRole('staff') || isAdmin();
    }
    
    // Check if user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is active (not banned)
    function isActive() {
      return isAuthenticated() && getUserData().status == 'active';
    }
    
    // Validate required string field
    function isValidString(field, minLen, maxLen) {
      return field is string && field.size() >= minLen && field.size() <= maxLen;
    }
    
    // Validate email format
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Validate Vietnamese phone number
    function isValidPhone(phone) {
      return phone.matches('^(0|\\+84)(3[2-9]|5[6|8|9]|7[0|6-9]|8[1-9]|9[0-9])[0-9]{7}$');
    }
    
    // Validate positive number
    function isPositiveNumber(num) {
      return num is number && num >= 0;
    }
    
    // Check if document is not soft deleted
    function isNotDeleted() {
      return !('deleted_at' in resource.data) || resource.data.deleted_at == null;
    }
    
    // ============================================
    // üîê USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Anyone can read their own profile
      // Staff can read all profiles
      // Admin can read all profiles
      allow read: if isOwner(userId) || isStaff();
      
      // Only admin can create users
      allow create: if isAdmin() && 
        isValidString(request.resource.data.full_name, 2, 100) &&
        isValidEmail(request.resource.data.email) &&
        isValidPhone(request.resource.data.phone) &&
        request.resource.data.role in ['admin', 'staff', 'member', 'guest'] &&
        request.resource.data.status in ['active', 'banned', 'pending'];
      
      // Users can update their own profile (except role and status)
      // Admin can update any profile
      allow update: if (isOwner(userId) && 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'status'])) ||
        isAdmin();
      
      // Only admin can delete (soft delete)
      allow delete: if isAdmin();
    }
    
    // ============================================
    // üèì VISITORS COLLECTION
    // ============================================
    match /visitors/{visitorId} {
      // Staff and admin can read all visitors
      // Members can only read their own visits
      allow read: if isStaff() || 
        (isAuthenticated() && resource.data.user_id == request.auth.uid);
      
      // Staff can create visitors
      allow create: if isStaff() &&
        isValidString(request.resource.data.visitor_name, 2, 100) &&
        isPositiveNumber(request.resource.data.price) &&
        request.resource.data.play_type in ['hourly', 'daily', 'monthly', 'yearly'] &&
        request.resource.data.payment_method in ['cash', 'transfer', 'momo', 'zalopay', 'card'];
      
      // Staff can update visitors
      allow update: if isStaff();
      
      // Only admin can delete (soft delete)
      allow delete: if isAdmin();
    }
    
    // ============================================
    // üßæ PAYMENTS COLLECTION
    // ============================================
    match /payments/{paymentId} {
      // Staff and admin can read all payments
      // Members can only read their own payments
      allow read: if isStaff() || 
        (isAuthenticated() && resource.data.user_id == request.auth.uid);
      
      // Staff can create payments
      allow create: if isStaff() &&
        isPositiveNumber(request.resource.data.amount) &&
        request.resource.data.amount >= 1000 && // Minimum 1000 VND
        request.resource.data.payment_method in ['cash', 'transfer', 'momo', 'zalopay', 'card'] &&
        request.resource.data.payment_status in ['pending', 'paid', 'failed', 'refunded', 'cancelled'];
      
      // Staff can update payment status
      allow update: if isStaff() &&
        request.resource.data.payment_status in ['pending', 'paid', 'failed', 'refunded', 'cancelled'];
      
      // Only admin can delete (soft delete)
      allow delete: if isAdmin();
    }
    
    // ============================================
    // üìÖ SCHEDULES COLLECTION
    // ============================================
    match /schedules/{scheduleId} {
      // Anyone can read active schedules
      allow read: if resource.data.status == 'active' && isNotDeleted();
      
      // Only admin can create schedules
      allow create: if isAdmin() &&
        request.resource.data.day_of_week in ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'] &&
        isValidString(request.resource.data.coach_name, 2, 100);
      
      // Only admin can update schedules
      allow update: if isAdmin();
      
      // Only admin can delete (soft delete)
      allow delete: if isAdmin();
    }
    
    // ============================================
    // üõí PRODUCTS COLLECTION
    // ============================================
    match /products/{productId} {
      // Anyone can read active products
      allow read: if resource.data.status == 'active' && isNotDeleted();
      
      // Admin can create products
      allow create: if isAdmin() &&
        isValidString(request.resource.data.name, 2, 200) &&
        isPositiveNumber(request.resource.data.price) &&
        isPositiveNumber(request.resource.data.stock) &&
        request.resource.data.category in ['racket', 'rubber', 'blade', 'ball', 'table', 'accessory', 'clothing', 'other'];
      
      // Admin and staff can update products (stock, status)
      allow update: if isStaff();
      
      // Only admin can delete (soft delete)
      allow delete: if isAdmin();
    }
    
    // ============================================
    // üì¶ ORDERS COLLECTION
    // ============================================
    match /orders/{orderId} {
      // Staff can read all orders
      // Members can only read their own orders
      allow read: if isStaff() || 
        (isAuthenticated() && resource.data.user_id == request.auth.uid);
      
      // Authenticated users can create orders
      allow create: if isAuthenticated() && isActive() &&
        isValidString(request.resource.data.customer_name, 2, 100) &&
        isValidPhone(request.resource.data.customer_phone) &&
        request.resource.data.items.size() >= 1 &&
        isPositiveNumber(request.resource.data.total_price) &&
        request.resource.data.payment_method in ['cash', 'transfer', 'momo', 'zalopay', 'card'];
      
      // Staff can update order status
      // Members can only cancel their own pending orders
      allow update: if isStaff() ||
        (isOwner(resource.data.user_id) && 
         resource.data.order_status == 'pending' &&
         request.resource.data.order_status == 'cancelled');
      
      // Only admin can delete (soft delete)
      allow delete: if isAdmin();
    }
    
    // ============================================
    // üìã CONTACTS COLLECTION
    // ============================================
    match /contacts/{contactId} {
      // Staff can read all contacts
      allow read: if isStaff();
      
      // Anyone can create contacts (public form)
      allow create: if 
        isValidString(request.resource.data.name, 2, 100) &&
        isValidPhone(request.resource.data.phone) &&
        isValidString(request.resource.data.message, 10, 2000);
      
      // Staff can update contacts (mark as read, reply)
      allow update: if isStaff();
      
      // Only admin can delete (soft delete)
      allow delete: if isAdmin();
    }
    
    // ============================================
    // üìù AUDIT_LOGS COLLECTION
    // ============================================
    match /audit_logs/{logId} {
      // Only admin can read logs
      allow read: if isAdmin();
      
      // System can create logs (from authenticated requests)
      allow create: if true; // Allow all creates for logging purposes
      
      // Logs cannot be updated or deleted
      allow update, delete: if false;
    }
    
    // ============================================
    // üîî NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isOwner(resource.data.user_id);
      
      // System can create notifications
      allow create: if isStaff();
      
      // Users can update (mark as read) their own notifications
      allow update: if isOwner(resource.data.user_id) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'read_at']);
      
      // Users can delete their own notifications
      allow delete: if isOwner(resource.data.user_id) || isAdmin();
    }
    
    // ============================================
    // üìä DAILY_STATS COLLECTION
    // ============================================
    match /daily_stats/{statId} {
      // Staff can read stats
      allow read: if isStaff();
      
      // Only system/admin can write stats
      allow write: if isAdmin();
    }
    
    // ============================================
    // üö´ DENY ALL OTHER ACCESS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
