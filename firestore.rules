rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // ðŸš« FORBIDDEN: allow write: if true
    // ============================================================
    // All writes must be validated and authorized
    
    // ============================================================
    // ðŸ”§ HELPER FUNCTIONS
    // ============================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isStaff() {
      return isAuthenticated() && (
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'staff'
      );
    }
    
    // Validate required string
    function isValidString(value, minLen, maxLen) {
      return value is string && value.size() >= minLen && value.size() <= maxLen;
    }
    
    // Validate Vietnamese phone
    function isValidPhone(phone) {
      return phone.matches('^(0|\\+84)[0-9]{9,10}$');
    }
    
    // Validate email
    function isValidEmail(email) {
      return email.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$');
    }
    
    // Validate positive number
    function isPositive(num) {
      return num is number && num > 0;
    }
    
    // Validate non-negative number
    function isNonNegative(num) {
      return num is number && num >= 0;
    }
    
    // Check timestamp is server time
    function isValidTimestamp(ts) {
      return ts == request.time;
    }
    
    // ============================================================
    // ðŸ‘¤ ADMINS COLLECTION (for role checking)
    // ============================================================
    match /admins/{userId} {
      // Only admin can read admin list
      allow read: if isAdmin();
      
      // Only existing admin can create new admin
      allow create, update: if isAdmin();
      
      // No delete
      allow delete: if false;
    }
    
    // ============================================================
    // ðŸ‘¥ MEMBERS COLLECTION
    // Created by: Admin only
    // ============================================================
    match /members/{memberId} {
      // Staff can read
      allow read: if isStaff();
      
      // Only admin can create
      allow create: if isAdmin() &&
        isValidString(request.resource.data.fullName, 2, 100) &&
        isValidPhone(request.resource.data.phone) &&
        request.resource.data.createdAt == request.time &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Only admin can update
      allow update: if isAdmin() &&
        request.resource.data.updatedAt == request.time;
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================
    // ðŸ“… SCHEDULES COLLECTION
    // Created by: Admin only
    // ============================================================
    match /schedules/{scheduleId} {
      // Anyone can read active schedules
      allow read: if resource.data.status == 'active' || isStaff();
      
      // Only admin can create
      allow create: if isAdmin() &&
        isValidString(request.resource.data.title, 3, 200) &&
        request.resource.data.dayOfWeek >= 0 &&
        request.resource.data.dayOfWeek <= 6 &&
        isNonNegative(request.resource.data.price) &&
        request.resource.data.createdAt == request.time &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Only admin can update
      allow update: if isAdmin() &&
        request.resource.data.updatedAt == request.time;
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================
    // ðŸ›’ PRODUCTS COLLECTION
    // Created by: Admin only
    // ============================================================
    match /products/{productId} {
      // Anyone can read active products
      allow read: if resource.data.status == 'active' || isStaff();
      
      // Only admin can create
      allow create: if isAdmin() &&
        isValidString(request.resource.data.name, 2, 200) &&
        isPositive(request.resource.data.price) &&
        isNonNegative(request.resource.data.stock) &&
        request.resource.data.createdAt == request.time &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Only admin can update
      allow update: if isAdmin() &&
        request.resource.data.updatedAt == request.time;
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================
    // ðŸ“§ CONTACTS COLLECTION
    // Created by: PUBLIC USERS (anyone via contact form)
    // ============================================================
    match /contacts/{contactId} {
      // Only staff can read
      allow read: if isStaff();
      
      // PUBLIC can create (contact form)
      // But with STRICT validation
      allow create: if 
        isValidString(request.resource.data.name, 2, 100) &&
        isValidPhone(request.resource.data.phone) &&
        isValidString(request.resource.data.message, 10, 2000) &&
        request.resource.data.status == 'new' &&
        request.resource.data.createdAt == request.time &&
        // Prevent bulk insert: no createdBy field for public
        !('createdBy' in request.resource.data);
      
      // Only staff can update (reply, mark as read)
      allow update: if isStaff();
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================
    // ðŸ“ VISITS COLLECTION
    // Created by: Staff or Admin
    // ============================================================
    match /visits/{visitId} {
      // Staff can read
      allow read: if isStaff();
      
      // Staff can create
      allow create: if isStaff() &&
        isValidString(request.resource.data.visitorName, 2, 100) &&
        isPositive(request.resource.data.price) &&
        request.resource.data.createdAt == request.time &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Staff can update
      allow update: if isStaff() &&
        request.resource.data.updatedAt == request.time;
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================
    // ðŸ’° PAYMENTS COLLECTION
    // Created by: Staff or Admin
    // ============================================================
    match /payments/{paymentId} {
      // Staff can read
      allow read: if isStaff();
      
      // Staff can create
      allow create: if isStaff() &&
        isPositive(request.resource.data.amount) &&
        request.resource.data.createdAt == request.time &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Staff can update status
      allow update: if isStaff() &&
        request.resource.data.updatedAt == request.time;
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================
    // ðŸ“¦ ORDERS COLLECTION
    // Created by: Staff or Admin
    // ============================================================
    match /orders/{orderId} {
      // Staff can read all, users can read own
      allow read: if isStaff();
      
      // Staff can create
      allow create: if isStaff() &&
        isValidString(request.resource.data.customerName, 2, 100) &&
        isValidPhone(request.resource.data.customerPhone) &&
        request.resource.data.items.size() >= 1 &&
        isPositive(request.resource.data.totalPrice) &&
        request.resource.data.createdAt == request.time;
      
      // Staff can update
      allow update: if isStaff() &&
        request.resource.data.updatedAt == request.time;
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================
    // ðŸ“‹ LOGS COLLECTION
    // Created by: System (any authenticated user)
    // ============================================================
    match /logs/{logId} {
      // Only admin can read logs
      allow read: if isAdmin();
      
      // Any authenticated user can create (for logging)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.createdAt == request.time;
      
      // Logs are IMMUTABLE - no update, no delete
      allow update, delete: if false;
    }
    
    // ============================================================
    // ðŸš« DENY ALL OTHER ACCESS
    // ============================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
